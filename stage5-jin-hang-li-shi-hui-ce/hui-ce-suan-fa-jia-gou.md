# 回测算法架构

股票交易，简单来说就是一买一卖，赚取差价。算法的目的在于将投资人的交易行为量化转化为代码。

回测算法就是通过历史数据，模拟真实的开盘环境，进行数据解读、计算、判断，决定是否建仓、平仓，获取成交信息。

量化回测的必要步骤：

1. 读取历史数据；
2. 转换回测指标；
3. 历史算法设计；
4. 历史回测回传明细格式设计；
5. 绩效计算。

## 读取历史数据

将.csv等文件内的历史数据读入内存中。

## 转换回测指标

“转换回测指标”就是将现有的历史数据进一步转换为指标（例如之前使用过的MA、价格高低点等）。

以下提供常见的交易指标，供大家参考。

（1）移动平均价(MA)

假如在期货交易市场上的交易算法是通过移动平均(MA)为主要的交易指标，那就会定义移动平均的周期以及长度。假设是10分MA，周期就是分钟，长度就是10，而显示出来的信息也就是由10分钟的每分钟收盘价所计算的指标。&#x20;

若10分MA通过前10分钟的收盘价计算，那就只能看到上一分钟的状态，无法掌控最新的市场价格动态。若获取 tick 数据，也就是逐笔信息，就能够依照最新的价格来进行计算，也就是说，从原本的10分钟收盘价变为9分钟的每笔收盘价加上当前的tick计算，可以即时地反映最新的市场动态。&#x20;

（2）当日价格高低点

回测指标所指的是当日的高低点，并非是直接通过历史数据获取当天的最高价和当天的最低价，而是回测时**逐笔地去计算当日最高价和最低价**。若回测当前时间为09:50:35，则目前的最高价和最低价就09:50:35以前的最高价和最低价。&#x20;

若直接取得当日高低点，可能会造成程序逻辑上的错误，所以在定义指标前必须先厘清观念。&#x20;

（3）内外盘量

内外盘是大家常用的指标之一，一般的计算方式为下一笔成交价落在上一档价（卖方价格）还是下一档价（买方价格），若价格落在上一档价时，则为“外盘价”；落在下一档价时，则为“内盘价”。 内外盘还有另外一种算法，就是当成交价大于上一笔成交价时，则为“外盘量"；反之，则为“内盘量”。 计算内外盘量的总和可以用来判断目前的多空方趋势：若外盘量较多，则多方趋势较空方趋势重，价格往上的概率较高；反之，若内盘量较多，则空方趋势较多方趋势重，价格往下的概率较高。

（4）委托手数差值

委托手数差值是通过委托信息来计算的，会将委托的买方手数以及委托的卖方手数相减。若值为负数，则代表目前委托买方手数较少，代表目前市场委托趋势较偏向空方；反之，若值为正数，则代表卖方手数较少，代表目前市场委托趋势较偏向多方。

（5）委托比重

委托比重指标是从委托信息计算而来的，会将委托的买卖方分别用手数除以笔数来计算买卖方的平均单笔手数，进而通过比重的方式计算该指标。假设委托的买方为100手、50笔，卖方为80手、20笔，则委托的买方平均手数为2手，卖方平均手数为4手，进而计算出多方委托比重为33.33%，空方委托比重66.67%。&#x20;

这个指标与委托手数差值指标最大的不同在于委托比重不会受到手数绝对的影响，就算买方的手数相当多，但笔数也相对多，还是有可能被空方趋势胜过。

（6）成交买卖单笔数

成交买卖单笔数是由成交信息获取的，通常交易者会根据成交买卖笔数来做趋势的判断，因为对于累积成交量，买卖方是相等的，所以当成交买笔数小于成交卖笔数时，代表成交买方平均手数大于卖方平均手数，这时就可以判断买方趋势大于卖方趋势。

## 历史算法设计

由于回测算法获取的是历史数据，因此在编写回测算法时可以依照需求去撷取需要的部分信息。假设交易算法只操作当日开盘的第二个小时，那么通过子集合的函数去获取那一段期间的数据即可，不必再从文件的开始读取到结尾。&#x20;

回测算法也是交易算法，所以依照流程会有<mark style="color:orange;">趋势判断、进场、出场和止损</mark>等相关步骤。

## 历史回测回传明细格式设计

回测交易格式的设计，是希望完整地保存回测交易记录，并真实地表达交易事件的细节，最后让这些记录能够被适度地分析，让回测的效益最佳化。 以下是交易事件回传格式:&#x20;

> 交易序列号、交易商品、开仓日期、开仓时间、开仓价格、买卖、数量、平仓日期、平仓时间、平仓价格、注记、税金、手续费、策略编号、交易者编号
>
> SerialNumber, Good, ODate, OTime, OPrice, BorS, Number, CDate, CTime, CPrice, Comment, Tax, Fee, PID, ID

大家看到这里，或许会好奇，为什么没有盈亏字段呢？首先，通过原有的数据字段就可以计算出盈亏，为了避免表格字段过于冗长，所以不另外设置字段。另外，若要观察回测的效益，除盈亏以外的分析对于交易而言也是相当重要的，后面会有介绍。

每个字段都具有存在的价值，而第一个字段交易序列号代表唯一值，所以每笔数据并不会发生重复的现象。上述交易回传格式不一定符合每种交易类型的需求，可以依照自己的需求做更改。 以下是开盘买、收盘卖的策略，做一个基础的交易回传明细：

```python
import pandas as pd

data = []
df = pd.read_csv("./data/600036_half_year.csv")
for index, row in df.iterrows():
    # 筛选你想要的数据
    data.append(row)

OrderTime = data[0]['tradeDate']  # 下单时间记录
OrderPrice = data[0]['openPrice']  # 下单价格记录
CoverTime = data[-1]['tradeDate']  # 卖出时间记录
CoverPrice = data[-1]['closePrice']  # 卖出价格记录
print("Buy OrderTime:", OrderTime, " OrderPrice:", OrderPrice,)
print("SaleTime:", CoverTime, " SalePrice:", CoverPrice, " Profit:", CoverPrice-OrderPrice)
```

执行回测后，输出如下：

```
Buy OrderTime: 2021-09-24  OrderPrice: 48.45
SaleTime: 2022-03-24  SalePrice: 45.77  Profit: -2.6799999999999997
```

注：最后的profit是浮点数精度问题，比如python中的0.1+0.2运算并不等于0.3。

## 绩效计算

读取交易记录后，就可以依照交易回传的数据去加以计算分析。绩效不仅可以从盈亏去观察，也可以从买卖、交易次数、交易时间点来进行分析。

某些策略会符合某些时期的趋势条件，但不代表那些策略会符合长期市场的走势，毕竟交易市场是瞬息万变的，若要调试出一个长期稳定获利的策略，必须要经过长期回测的测试。&#x20;
